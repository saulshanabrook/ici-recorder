version: '3.2'
services:
  # jupyterhub:
  #   build: jupyterhub
  #   environment:
  #     DOCKER_NOTEBOOK_IMAGE: "saulshanabrook/ici-recorder-jupyter-notebook"
  #     DOCKER_NETWORK_NAME: "icirecorder_default"
  #   volumes:
  #     # Bind Docker socket on the host so we can connect to the daemon from
  #     # within the container
  #     - "/var/run/docker.sock:/var/run/docker.sock:rw"
  #   ports:
  #    - "443:443"
  jupyter-notebook:
    build: jupyter-notebook
    image: icirecorder/jupyter-notebook:${TAG:-latest}
    volumes:
      - notebooks:/home/jovyan/work
    command: start-notebook.sh --NotebookApp.password='sha1:b689bdb78b77:c2e53af00e537fd286497049896c4487d69b6089'
    ports:
      - target: 8888
        published: 80
        protocol: tcp
        mode: ingress
  alluxio-master:
    image: icirecorder/alluxio:${TAG:-latest}
    build:
      context: alluxio-server
      # args:
        # use newer version to get https://github.com/Alluxio/alluxio/pull/4771/files
        # - REF=fae727c2236d0c5dfe53c04006dd70509cb38b94
    # image: icirecorder/alluxio:${TAG:-latest}
    command: [master]
    environment:
      ALLUXIO_MASTER_HOSTNAME: ${SERVER_HOST:-alluxio-master}
      ALLUXIO_WORKER_HOSTNAME: ${SERVER_HOST:-alluxio-worker}
    volumes:
      - alluxio:/under
    expose:
      - 19998
      - 19999
    ports:
      - "19998:19998"
      - "19999:19999"
      # - target: 19998
      #   published: 19998
      #   protocol: tcp
      #   mode: ingress
      # - target: 19999
      #   published: 19999
      #   protocol: tcp
      #   mode: ingress
  alluxio-worker:
    image: icirecorder/alluxio:${TAG:-latest}
    build:
      context: alluxio-server
      # args:
        # use newer version to get https://github.com/Alluxio/alluxio/pull/4771/files
        # - REF=fae727c2236d0c5dfe53c04006dd70509cb38b94
    # image: icirecorder/alluxio:${TAG:-latest}
    command: [worker]
    environment:
      ALLUXIO_MASTER_HOSTNAME: ${SERVER_HOST:-alluxio-master}
      ALLUXIO_WORKER_HOSTNAME: ${SERVER_HOST:-alluxio-worker}
    volumes:
      - alluxio:/under
    expose:
      - 29998
      - 29999
      - 30000
    ports:
      - "29998:29998"
      - "29999:29999"
      - "30000:30000"
    # hostname: ${HOST:-0.0.0.0}
volumes:
  notebooks:
  alluxio:
